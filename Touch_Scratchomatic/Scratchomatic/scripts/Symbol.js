var SymbolZIndices={BACKGROUND:10,POP_UNDER:20,PRIZE:30,VALUE:40,SPRITE:50,FOIL:100,POP_OVER:110};Symbol=function(a){if(!a||!a.group)throw new Error("missing config group on Symbol init!");var b,c,d,e,f,g,h,j,k=a.texMult||1,l=this,m=a.group,n=a.backgroundObj||null,o=a.value||"none",p=a.valueObj||null,q=a.prize||"none",r=a.prizeObj||null,s=a.specialObjs||[],t=a.foilImage||null,u=a.foilContext||null,v=a.x||0,w=a.y||0,x=null,y=a.scratchSprite||null,z=a.prizeSymbol===!0,A=function(a){switch(a){case"value":case"Value":return p;case"prize":case"Prize":return r;case"background":case"backGround":case"Background":return n;case"foil":case"Foil":return t;default:return l.getSpecialObj(a)}},B=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=t.width,b.height=t.height,a.draw(c,0,b.width/2,b.height/2),c.globalCompositeOperation="destination-in",t.spriteImage?c.drawImage(t.image,0,0,t.spriteWidth,t.spriteHeight):c.drawImage(t.image,0,0);var d=new PGCImage(b,a.x,a.y);return d.anchor=PGCAnchors.CENTRE,d.unCropped=a,d.zIndex=a.zIndex,d.nameVal=a.nameVal,d.visible=a.visible,d},C=function(a){return a&&a.unCropped?(m.getScene().removeFromScene(a),m.getScene().addToScene(a.unCropped,a.zIndex),a.unCropped):a};this.getX=function(){return v/k},this.getY=function(){return w/k},this.getWidth=function(){return c/k},this.getHeight=function(){return d/k},this.setPosition=function(a,b){return v=a*k,w=b*k,m.requestDraw(),this},this.getTouchBBox=function(){return null!==x?x:{x:v-c/2,y:w-d/2,w:c,h:d}},this.setTouchBBox=function(a,b,c,d){return x={x:(v+a)*k,y:(w+b)*k,w:c*k,h:d*k},m.requestDraw(),this},this.getScratchBBox=function(){return null!==e?e:{x:(v-c/2)/k,y:(w-d/2)/k,w:c/k,h:d/k}},this.setScratchBBox=function(a,b,c,d){return e={x:v+a,y:w+b,w:c,h:d},m.requestDraw(),f=new ScratchMask(e),this},this.getScratchMask=function(){return f},this.getScratched=function(){return g},this.setScratched=function(a){g=a},this.setScratchAnimating=function(a){h=a!==!1},this.getScratchAnimating=function(){return h},this.getBackgroundObj=function(){return n},this.getValue=function(){return o},this.getValueObj=function(){return p},this.getPrize=function(){return q},this.getPrizeObj=function(){return r},this.getSpecialObj=function(a){a=a||"default";for(var b=0;b<s.length;b++)if(s[b].nameVal===a)return s[b];return{}},this.getSpecialObjInList=function(a){for(var b,c=0;c<a.length;c++)if(b=l.getSpecialObj(a[c]),Object.keys(b).length>0)return b;return{}},this.getFoilImage=function(){return t},this.getFoilContext=function(){return u},this.getFoilRect=function(){return b?b:new PGCRect(0,0,0,0)},this.getGroup=function(){return m},this.getPrizeSymbol=function(){return z},this.setTimeLine=function(a){j=a,j.start()},this.unsetTimeLine=function(){j.stop(),j=null},this.skinSelect=function(a){return arguments[pgc.Game.chosenTheme-1]},this.pulse=function(a){if(!a.partName&&!a.partReference)throw new Error("partName or partReference must be specified in animation functions!");if(a.partName&&a.partReference&&a.partName!==a.partReference.nameVal)throw new Error("Cannot animate parts '"+a.partName+"' and '"+a.partReference.nameVal+"' in the same function call!");var b=a.partReference?a.partReference:A(a.partName);if(null!==b){if(a.totalTime&&a.firstScaleTime&&!a.lastScaleTime?a.lastScaleTime=a.totalTime-a.firstScaleTime:a.totalTime&&!a.firstScaleTime&&a.lastScaleTime?a.firstScaleTime=a.totalTime-a.lastScaleTime:!a.totalTime||a.firstScaleTime||a.lastScaleTime?!a.totalTime&&a.firstScaleTime&&a.lastScaleTime?a.totalTime=a.firstScaleTime+a.lastScaleTime:a.totalTime||a.firstScaleTime||a.lastScaleTime||(a.totalTime=750,a.firstScaleTime=375,a.lastScaleTime=375):(a.firstScaleTime=a.totalTime/2,a.lastScaleTime=a.lastScaleTime/2),a.totalTime&&a.firstScaleTime&&a.lastScaleTime&&a.totalTime!==a.firstScaleTime+a.lastScaleTime||a.totalTime<0||a.firstScaleTime<0||a.lastScaleTime<0)throw new Error("Ambiguous scaling times provided!");a.setVisible=a.setVisible||!0,a.firstScale=a.firstScale||1.5,a.lastScale=a.lastScale||1,a.loop=a.loop||!1;var c,d,e,f,g=a.firstScale,h=a.lastScale,i=a.firstScaleTime,j=a.lastScaleTime,k=a.loop,l=a.afterFirstScale,m=a.afterLastScale;b.visible=a.setVisible,c=function(){0===i?d():b.growTo(g,i/1e3,d)},e=function(){0===j?f():b.growTo(h,j/1e3,f)},d=l?function(){l(b),e()}:e,m?f=function(){m(b),k&&(b.setScaling(a.firstScale),c())}:k&&(f=function(){b.setScaling(a.firstScale),c()}),c()}},this.modifyBackground=function(a){var b=pgc.Game.ScratchController.multiplyConfig(a);b.source&&n.setImage(ip.getPreloadedImage(b.source)),n.spriteX=b.sampleX?b.sampleX:n.spriteX,n.spriteY=b.sampleY?b.sampleY:n.spriteY,n.spriteWidth=b.sampleWidth?b.sampleWidth:n.spriteWidth,n.spriteHeight=b.sampleHeight?b.sampleHeight:n.spriteHeight},this.modifyValue=function(a){var b=pgc.Game.ScratchController.multiplyConfig(a);null!==p&&p.setImage(m.getValueFactory().modify(b).createTextImage(o))},this.modifyPrize=function(a){if(null!==r){var b=pgc.Game.ScratchController.multiplyConfig(a),c=z?m.getPrizeSymbolPrizeFactory():m.getPrizeFactory();r.setImage(c.modify(b).createTextImage(q))}},this.animatePart=function(a){if(!a.partName&&!a.partReference)throw new Error("partName or partReference must be specified in animation functions!");if(a.partName&&a.partReference&&a.partName!==a.partReference.nameVal)throw new Error("Cannot animate parts '"+a.partName+"' and '"+a.partReference.nameVal+"' in the same function call!");a.count=a.count||1,a.visibleAfter=a.visibleAfter!==!1;var b=a.partReference?a.partReference:A(a.partName);if(null!==b){if(b.visible=!0,!b.frames)throw new Error("Trying to animate non-animated symbol part!");var c=a.visibleAfter,d=a.count;b.run(function(){b.visible=c,m.requestDraw()},d,0)}},this.addSelfToScene=function(){var a=m.getScene();if(null!==n&&a.addToScene(n,SymbolZIndices.BACKGROUND),null!==p&&a.addToScene(p,SymbolZIndices.VALUE),null!==r&&a.addToScene(r,SymbolZIndices.PRIZE),s.length>0)for(var b=0;b<s.length;b++)a.addToScene(s[b],s[b].zIndex);return null!==t&&a.addToScene(t,SymbolZIndices.FOIL),m.requestDraw(),this},this.removeSelfFromScene=function(){var a=m.getScene();if(null!==n&&a.removeFromScene(n),null!==p&&a.removeFromScene(p),null!==r&&a.removeFromScene(r),s.length>0)for(var b=0;b<s.length;b++)a.removeFromScene(s[b]);return null!==t&&a.removeFromScene(t),m.requestDraw(),this},this.scratch=function(a,c,d,e){if(!g){var h;if(t.spriteImage)for(h=0;h<t.frames.length;h++)a.draw(u,0,d-b.left+t.frames[h].x,e-b.top+t.frames[h].y);else a.draw(u,0,d-b.left,e-b.top);f.collisionRects(c),f.scratched()&&this.animateScratch(),m.requestDraw()}return this},this.animateScratch=function(){return h=!0,null!==y?y.run(function(){f.setScratched(!0),h=!1},1):(f.setScratched(!0),g=!0),m.requestDraw(),this},this.step=function(a){var b;if(j&&j.step(a),!g&&!h&&f.scratched()){for(g=!0,p=C(p),r=C(r),b=0;b<s.length;b++)s[b]=C(s[b]);m.triggerAnimation({trigger:pgc.ScratchAnimationTriggers.SCRATCHED,symbols:[l]}),pgc.Game.UserData.setGameSpecificData(m.getScene().id,m.save()),m.requestDraw()}if(null!==y&&y.runFrameAnimation){var c=((t.spriteImage?t.spriteWidth:t.width)-y.spriteWidth)/2,d=((t.spriteImage?t.spriteHeight:t.height)-y.spriteHeight)/2;if(t.frames)for(b=0;b<t.frames.length;b++)y.draw(u,a,t.frames[b].x+c,t.frames[b].y+d,!1);else y.draw(u,a,c,d,!1);m.requestDraw()}},this.forEachSprite=function(a){var b,c=[n,p,r,t,y].concat(s);for(b=0;b<c.length;b++)c[b]&&null!==c[b]&&a(c[b]);m.requestDraw()},this.toString=function(){var a=m.getSymbols();return"Symbol "+a.indexOf(l)+" of "+a.length+" at ("+v+", "+w+") - value: "+o+" prize: "+q+" - "+(g?"scratched":"unscratched")};var D=function(){if(a.width)c=a.width;else if(a.backgroundObj)c=a.backgroundObj.spriteWidth;else{if(!t)throw new Error("unable to establish symbol width! Symbols must have a background or foil image to establish their width!");c=t.width}if(a.height)d=a.height;else if(a.backgroundObj)d=a.backgroundObj.spriteHeight;else{if(!t)throw new Error("unable to establish symbol width! Symbols must have a background or foil image to establish their width!");d=t.height}for(t||(g=!0),a.scratchBBox?l.setScratchBBox(a.scratchBBox.offsetX,a.scratchBBox.offsetY,a.scratchBBox.w,a.scratchBBox.h):l.setScratchBBox(-c/2,-d/2,c,d),p&&p.cropToFoil&&(p=B(p)),r&&r.cropToFoil&&(r=B(r)),i=0;i<s.length;i++)s[i].cropToFoil&&(s[i]=B(s[i]));f=new ScratchMask(e),b=a.foilImage?new PGCRect(v-t.width/2,w-t.height/2,v+t.width/2,w+t.height/2):null};D()};