var CanvasText=function(a){if(a=a||{},a.strokeStyles=a.strokeStyles||(a.strokeStyle?[a.strokeStyle]:[]),a.lineWidths=a.lineWidths||(a.lineWidth?[a.lineWidth]:[]),a.strokeStyles.length!==a.lineWidths.length)throw new Error("number of stroke styles and line widths do not match!");var b=this,c=a.fontFamily||"Arial",d=a.fontSize||"10px",e=a.fontStyle||"normal",f=a.fontWeight||"normal",g=a.fontVariant||"normal",h=a.fillStyle||"black",i=a.strokeStyles,j=a.lineWidths,k=a.shadowColour||null,l=a.shadowBlur||0,m=a.shadowOffsetX||0,n=a.shadowOffsetY||0,o=!0,p=-1,q=a.measureHeightString||"IQqgjiy|0123456789,",r=a.baseHeightString||"WWW",s=a.location,t=parseInt(a.minimumTextHeight,10)||5,u=function(a,b){var c=b.getContext("2d");if(b.id="textCanvas",b.visibility="hidden",document.body.appendChild(b),c.font=w(),b.width=c.measureText(a).width+Math.max(2*Math.max.apply(null,j),0),c.font=w(),c.textBaseline="middle",c.textAlign="center",null!==k&&(c.shadowColor=k,c.shadowBlur=l,c.shadowOffsetX=m,c.shadowOffsetY=n),i.length>0){c.lineWidth=j[0],c.strokeStyle=i[0],c.strokeText(a,b.width/2,b.height/2),null!==k&&(c.shadowColor="transparent",c.strokeText(a,b.width/2,b.height/2));for(var d=1;d<i.length;d++)c.lineWidth=j[d],c.strokeStyle=i[d],c.strokeText(a,b.width/2,b.height/2)}return null!==h&&(c.fillStyle=h,c.fillText(a,b.width/2,b.height/2)),document.body.removeChild(b),b},v=function(a){if(a=String(a),a.indexOf("px")>0||String(parseInt(a,10))===a)return parseInt(a,10);var b=document.createElement("canvas"),d=b.getContext("2d");s&&s.appendChild(b),d.font=[e,f,g,a,c].join(" "),s&&s.removeChild(b);var h=parseInt(d.font,10);return d=null,b=null,h},w=function(){var a=[e,f,g,d,c].join(" ");return a};this.setFontFamily=function(a){return c=a,o=!0,this},this.setFontSize=function(a){return d=a,o=!0,this},this.setFontStyle=function(a){return e=a,o=!0,this},this.setFontWeight=function(a){return f=a,o=!0,this},this.setFontVariant=function(a){return g=a,o=!0,this},this.setFillStyle=function(a){return h=a,this},this.setBaseHeightString=function(a){return r=a,o=!0,this},this.setShadow=function(a,b,c,d){return k=a,l=b,m=c,n=d,o=!0,this},this.setMinimumTextHeight=function(a){var b=parseInt(a,10);return isNaN(b)||(t=b,o=!0),this},this.addStroke=function(a,b){return i.push(a),j.push(b),o=!0,this},this.removeStroke=function(a){var b=i.indexOf(a);return b>-1&&(i.splice(b,1),j.splice(b,1),o=!0),this},this.measureTextHeight=function(a){"undefined"!=typeof a&&(q=a);var b=document.createElement("canvas"),c=b.getContext("2d");c.font=w();var d=c.measureText(r).width;b.width=c.measureText(q).width,b.height=d,b=u(q,b);for(var e=c.getImageData(0,0,b.width,b.height).data,f=b.height,g=0,h=0,i=[[]],j=3;j<e.length;j+=4)g===b.width?(g=0,h++,i.push([])):g++,i[h].push(e[j]);for(h=0;h<i.length;h++){var k=!0;for(g=0;g<i[0].length;g++)if(0!==i[h][g]){k=!1;break}k&&f--}return p=f+2,o=!1,p},this.createTextImage=function(a){if(o||t>p){d=v(d)+"px";for(var b=0;b<j.length;b++)j[b]=v(j[b]);m=v(m),n=v(n),this.measureTextHeight()}var c=document.createElement("canvas");c.getContext("2d");return c.height=p,u(a,c)},this.modify=function(a){a.strokeStyles=a.strokeStyles||(a.strokeStyle?[a.strokeStyle]:[]),a.lineWidths=a.lineWidths||(a.lineWidth?[a.lineWidth]:[]);var c,d=a.shadowColour||null,e=a.shadowBlur||0,f=a.shadowOffsetX||0,g=a.shadowOffsetY||0;if(a.fontFamily&&b.setFontFamily(a.fontFamily),a.fontSize&&b.setFontSize(a.fontSize),a.fontStyle&&b.setFontStyle(a.fontStyle),a.fontWeight&&b.setFontWeight(a.fontWeight),a.fontVariant&&b.setFontVariant(a.fontVariant),a.fillStyle&&b.setFillStyle(a.fillStyle),a.strokeStyles.length!==a.lineWidths.length)throw new Error("number of stroke styles and widths do not match!");if(a.strokeStyles.length>0)for(i=[],j=[],c=0;c<a.strokeStyles.length;c++)b.addStroke(a.strokeStyles[c],a.lineWidths[c]);return null!==d&&b.setShadow(d,e,f,g),a.baseHeightString&&a.baseHeightString!==r&&(r=a.baseHeightString,o=!0),a.measureHeightString&&a.measureHeightString!==q&&(q=a.measureHeightString,o=!0),this},this.clone=function(){for(var a=new CanvasText({fontFamily:c,fontSize:d,fontStyle:e,fontWeight:f,fontVariant:g,fillStyle:h,shadowColour:k,shadowBlur:l,shadowOffsetX:m,shadowOffsetY:n,baseHeightString:r,measureHeightString:q}),b=0;b<i.length;b++)a.addStroke(i[b],j[b]);return a}};