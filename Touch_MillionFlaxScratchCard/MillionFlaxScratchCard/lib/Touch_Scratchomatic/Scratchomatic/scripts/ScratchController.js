pgc.ScratchBrushTypes={SCRATCH:1,WAND:2},pgc.ScratchGameTypes={LUCKY_NUMBERS:1,MATCH_X:2,DISPLAY:3},pgc.ScratchAnimationTriggers={START:1,LAST_INTRO_ANIMATION:1,SCRATCHED:2,WIN:3,ALL_SCRATCHED:4,GAME_OVER:5,GAMEOVER:5,TAP_INTERRUPT:6,CUSTOM00:100,CUSTOM01:101,CUSTOM02:102},pgc.CanvasFitModes={SCALE:1,RESIZE:2,NONE:3},pgc.ScratchConstants={MULTI_SYMBOL_DELIMITER:":"},pgc.Priorities={LOWEST:1,LOW:5,NORMAL:10,HIGH:15,HIGHER:20,HIGHEST:25};var ScratchController=function(){var a,b,c,d,e,f=5,g=this,h=300,i=!1,j=null,k=[],l=[],m=[],n=[],o=[],p=!1,q=!0,r=0,s=function(){var a=urlConverter.device;return a.search("/x[^1]")>0&&a.search("/x[^0]")>0||a.search("640x960")>0?2:1},t=function y(){var a,b,c;for(c=!0,a=0;a<k.length;a++)k[a].step(),k[a].allScratched()||(c=!1);for(c&&q&&!p&&g.gameOver(),a=0;a<o.length;a++){for(c=o[a].length>0,b=0;b<o[a].length;b++)if(!o[a][b].getScratched()){c=!1;break}c&&(k.forEach(function(b){b.triggerAnimation({trigger:pgc.ScratchAnimationTriggers.WIN,symbols:o[a]})}),o[a]=[])}for(a=0;a<l.length;a++)l[a].update();for(a=0;a<m.length;a++){var e=l.indexOf(m[a]);if(!(e>-1))throw new Error("attempt to remove extra scene that doesn't exist in the render queue!");l.splice(e,1)}m=[],d=requestAnimationFrame(y)},u=function(a,b,c){var d,e,f,g=0,h=c*b[0].multiSize,i=[];for(d=0;d<a.length;d++)for(f=a[d].getSymbols(b[d]),e=0;e<f.length;e++)if("PRIZE_SYMBOL"!==f[e].getValue()){if(g>=h&&i.push(f[e]),i.length===b[0].multiSize)return i;g++}throw new Error("Attempt to find non-existant symbol!")},v=function(a){var b=a.getSymbols().length,c=a.getGroupSize();if(b===c)throw new Error("Attempt to populate group with no free symbol positions!");return b},w=function(a){var b,c,d,e,f,g,h,i,j,l=[],m=a.scardIndex||0,n=a.gameIndex||0;if(g=a.winningCombinations||pgc.Game.Server.Response.scards[m].games[n].winningCombinations||{},a.userFoilsGroups){for(d=a.userFoils?a.userFoils:pgc.Game.Server.Response.scards[m].games[n].userFoils,b=0;b<d.length;b++)l.push({value:d[b]});for(b=0;b<a.userFoilsGroups.length;b++)k.indexOf(a.userFoilsGroups[b])<0?(a.userFoilsGroups[b].clearSymbols(),i=l.splice(0,a.userFoilsGroups[b].getGroupSize()),j=a.userFoilsGroups[b].setSymbols(i),a.userFoilsSettings=[{start:0,length:j,multiSize:i.length>0?String(i[0].value).split(pgc.ScratchConstants.MULTI_SYMBOL_DELIMITER).length:1}],k.push(a.userFoilsGroups[b])):(h=a.userFoilsSettings&&a.userFoilsSettings[b]?a.userFoilsSettings[b].start:v(a.userFoilsGroups[b]),i=l.splice(0,a.userFoilsGroups[b].getGroupSize()),j=a.userFoilsGroups[b].setSymbols(i,h),a.userFoilsSettings[b]={start:h,length:j,multiSize:i.length>0?String(i[0].value).split(pgc.ScratchConstants.MULTI_SYMBOL_DELIMITER).length:1})}if(a.playFieldsGroups){for(e=a.playFields?a.playFields:pgc.Game.Server.Response.scards[m].games[n].playFields,b=0;b<e.length;b++)c=pgc.Game.multiCurrencyManager.formatAmount(e[b].prize,!1,!0,2)+",-",l.push({prize:c,value:e[b].value});for(b=0;b<a.playFieldsGroups.length;b++)k.indexOf(a.playFieldsGroups[b])<0?(a.playFieldsGroups[b].clearSymbols(),i=l.splice(0,a.playFieldsGroups[b].getGroupSize()),j=a.playFieldsGroups[b].setSymbols(i),a.playFieldsSettings=[{start:0,length:j,multiSize:i.length>0?String(i[0].value).split(pgc.ScratchConstants.MULTI_SYMBOL_DELIMITER).length:1}],k.push(a.playFieldsGroups[b])):(h=a.playFieldsSettings&&a.playFieldsSettings[b]?a.playFieldsSettings[b].start:v(a.playFieldsGroups[b]),i=l.splice(0,a.playFieldsGroups[b].getGroupSize()),j=a.playFieldsGroups[b].setSymbols(i,h),a.playFieldsSettings[b]={start:h,length:j,multiSize:i.length>0?String(i[0].value).split(pgc.ScratchConstants.MULTI_SYMBOL_DELIMITER).length:1});a.gameType===pgc.ScratchGameTypes.LUCKY_NUMBERS?Object.keys(g).forEach(function(c){var d,e,f=parseInt(c,10);if(f>0&&!isNaN(f))for(d=u(a.userFoilsGroups,a.userFoilsSettings,f-1),b=0;b<g[c].positions.length;b++)e=u(a.playFieldsGroups,a.playFieldsSettings,g[c].positions[b]),o.push(d.concat(e))}):a.gameType===pgc.ScratchGameTypes.MATCH_X?Object.keys(g).forEach(function(b){for(var c=[],d=(parseInt(b,10),0);d<g[b].positions.length;d++)c=c.concat(u(a.playFieldsGroups,a.playFieldsSettings,g[b].positions[d]));o.push(c)}):o=[]}if(a.bonusPrizesGroups){for(f=a.bonusPrizes?a.bonusPrizes:pgc.Game.Server.Response.scards[m].games[n].bonusPrizes,b=0;b<f.length;b++)c=pgc.Game.multiCurrencyManager.formatAmount(f[b],!1,!0,2)+",-",l.push({value:f[b],prize:c});for(b=0;b<a.bonusPrizesGroups.length;b++)k.indexOf(a.bonusPrizesGroups[b])<0?(a.bonusPrizesGroups[b].clearSymbols(),i=l.splice(0,a.bonusPrizesGroups[b].getGroupSize()),j=a.bonusPrizesGroups[b].setSymbols(i),k.push(a.bonusPrizesGroups[b]),a.bonusPrizesSettings=[{start:0,length:j,multiSize:i.length>0?String(i[0].value).split(pgc.ScratchConstants.MULTI_SYMBOL_DELIMITER).length:1}]):(h=a.bonusPrizesSettings&&a.bonusPrizesSettings[b]?a.bonusPrizesSettings[b].start:v(a.bonusPrizesGroups[b]),i=l.splice(0,a.bonusPrizesGroups[b].getGroupSize()),j=a.bonusPrizesGroups[b].setSymbols(i,h),a.bonusPrizesSettings[b]={start:h,length:j,multiSize:i>0?String(i[0].value).split(pgc.ScratchConstants.MULTI_SYMBOL_DELIMITER).length:1});for(b=0;b<f.length;b++)o.push(u(a.bonusPrizesGroups,a.bonusPrizesSettings,b))}},x=function(d){if("InGame"===pgc.Game.StateMachine.current){d||(d=window.event);var e;switch(d.type){case"touchstart":case"touchmove":case"touchend":e={x:d.changedTouches[0].clientX,y:d.changedTouches[0].clientY};break;case"mousedown":case"mousemove":case"mouseup":e={x:d.clientX,y:d.clientY};break;default:return}pgc.Game.updateAmbientLastEventTime(),pgc.Game.idleManager.reset(),d.preventDefault(),d.stopPropagation();var g,k,l,m,n,o;switch(d.type){case"touchstart":case"mousedown":pgc.Game.isAudioEngineDelayedLoad()&&pgc.Game.preloadAudioMobileFallback(),i=!0,a=(new Date).getTime(),pgc.Game.idleManager.reset();break;case"touchmove":case"mousemove":if(i){if(m=[e],null!==j)for(l=CanvasToolkit.pointDistance(j,e),g=0;l>g;g+=f)m.push(CanvasToolkit.lerp(j,e,g/l));for(g=0;g<m.length;g++)for(k=0;k<pgc.Game.symbolGroupReferences.length;k++)switch(n=pgc.Game.symbolGroupReferences[k],o=windowToCanvas(n.getScene().canvas,m[g].x,m[g].y),c){case pgc.ScratchBrushTypes.WAND:n.tapReveal(o.x,o.y);break;default:n.scratch(b,o.x,o.y),n.requestDraw()}pgc.Game.updateTimeSinceLastScratchEvent(),j=e,pgc.Game.idleManager.reset()}break;case"touchend":case"mouseup":var p=(new Date).getTime();if(i&&h>p-a)for(k=0;k<pgc.Game.symbolGroupReferences.length;k++){n=pgc.Game.symbolGroupReferences[k],o=windowToCanvas(n.getScene().canvas,e.x,e.y);var q=n.tapReveal(o.x,o.y);null!==q&&pgc.Game.getAudioEngine().playSound(pgc.Game.ScratchController.skinSelect(pgc.Game.audio.names.main),pgc.Game.ScratchController.skinSelect(pgc.Game.audio.names.instantScratch))}j=null,i=!1,pgc.Game.idleManager.reset()}}};return this.getTextureMultiplier=function(){return e},this.getWinningSymbols=function(){return o},this.setTapTime=function(a){return h=a,this},this.setScratchBrush=function(a){return b=a.brushSprite,c=a.brushType,a.scaling>0&&1!==a.scaling&&a.brushSprite&&b.setScaling(a.scaling),this},this.setAutoGameOver=function(a){return q=a!==!1,this},this.skinSelect=function(a){if("object"!=typeof a||!a.length)return a;var b=pgc.Game.chosenTheme-1;return a.length>b?a[b]:void console.error("skinSelect failed on object "+a)},this.initialiseGame=function(a){var b=a;return a.userFoilsGroups&&(b.userFoilsGroups=a.userFoilsGroups.length?a.userFoilsGroups:[a.userFoilsGroups],b.userFoilsSettings=[]),a.playFieldsGroups&&(b.playFieldsGroups=a.playFieldsGroups.length?a.playFieldsGroups:[a.playFieldsGroups],b.playFieldsSettings=[]),a.bonusPrizesGroups&&(b.bonusPrizesGroups=a.bonusPrizesGroups.length?a.bonusPrizesGroups:[a.bonusPrizesGroups],b.bonusPrizesSettings=[]),a.scardIndex=a.scardIndex||0,a.gameIndex=a.gameIndex||0,-1===n.indexOf(a)&&n.push(a),a},this.gameOver=function(a){return a||k.forEach(function(a){a.triggerAnimation({trigger:pgc.ScratchAnimationTriggers.GAMEOVER})}),p||setTimeout(function(){pgc.Game.StateMachine.summary(),PGCUniverse.PGCToolkit.resetAnimation("winPopupCoinShower")},r),p=!0,this},this.modifyGameConfig=function(a,b){var c=n.indexOf(a);if(0>c)throw new Error("Attempt to modify non-existant scratch game! Only attempt to modify game configs returned by initialiseGame!");return n[c].scardIndex="undefined"!=typeof b.scardIndex?b.scardIndex:a.scardIndex,n[c].gameIndex="undefined"!=typeof b.gameIndex?b.gameIndex:a.gameIndex,n[c].userFoilsGroups="undefined"!=typeof b.userFoilsGroups?b.userFoilsGroups:a.userFoilsGroups,n[c].playFieldsGroups="undefined"!=typeof b.playFieldsGroups?b.playFieldsGroups:a.playFieldsGroups,n[c].bonusPrizesGroups="undefined"!=typeof b.bonusPrizesGroups?b.bonusPrizesGroups:a.bonusPrizesGroups,n[c]},this.clearGameConfigs=function(){n=[]},this.startNewGame=function(){k=[];for(var a=0;a<n.length;a++)w(n[a],o[a]);for(a=0;a<k.length;a++)r=Math.max(r,k[a].getMaxAnimationDuration()),k[a].render();p=!1,d||t(),k.forEach(function(a){a.triggerAnimation({trigger:pgc.ScratchAnimationTriggers.START})})},this.getGameConfigs=function(){return n.slice()},this.repopulate=function(a){if(a.gameConfig){var b=n.indexOf(a.gameConfig);b>-1&&(g.modifyGameConfig(n[b],{scardIndex:a.scardIndex||n[b].scardIndex,gameIndex:a.gameIndex||n[b].gameIndex}),w({userFoilsGroups:n[b].userFoilsGroups,playFieldsGroups:n[b].playFieldsGroups,bonusPrizesGroups:n[b].bonusPrizesGroups,scardIndex:n[b].scardIndex,gameIndex:n[b].gameIndex,userFoils:a.userFoils,playFields:a.playFields,bonusPrizes:a.bonusPrizes,winningCombinations:a.winningCombinations,userFoilsSettings:n[b].userFoilsSettings,playFieldsSettings:n[b].playFieldsSettings,bonusPrizesSettings:n[b].bonusPrizesSettings}))}else for(var c=0;c<n.length;c++)w(n[c])},this.createBrushMasks=function(a){for(var b,c=[],d=0;d<a.length;d++){if(b=new PGCImage(ip.getPreloadedImage(a[d])),null===b)throw new Error("Scratch mask not found: "+a[d]);b.setGlobalCompositeOperation("destination-out"),b.anchor=PGCAnchors.CENTRE,c.push(b)}return c},this.addExtraScene=function(a){return l.push(a),this},this.removeExtraScene=function(a){return m.push(a),this},this.multiplyConfig=function(a){var b={},c=["sampleX","sampleY","sampleWidth","sampleHeight","x","y","offsetX","offsetY","spriteWidth","spriteHeight","spriteX","spriteY","shadowOffsetX","shadowOffsetY","lineWidth","maxWidth"];return Object.keys(a).forEach(function(d){"undefined"!=typeof a[d]&&(b[d]=a[d],c.indexOf(d)>-1&&(b[d]*=e),"fontSize"===d&&(b[d]=parseFloat(b[d])*e+b[d].match(/[^\d\.]*$/)[0]),"lineWidths"===d&&(b[d]=[],a[d].forEach(function(a){var c=parseFloat(a)*e+String(a).match(/[^\d\.]*$/)[0];b[d].push(c)})),"frames"===d&&(b[d]=[],a[d].forEach(function(a){var c=pgc.Game.ScratchController.multiplyConfig(a);b[d].push(c)})))}),b},this.createSprite=function(a){var b,c=this.multiplyConfig(a);b="string"==typeof c.source?ip.getPreloadedImage(c.source):c.source;var d=new PGCSprite(b,c.x,c.y,c.sampleX,c.sampleY,c.sampleWidth,c.sampleHeight);return c.frames&&d.setFrames(c.frames,c.frameRate),d.visible=c.visible,d.zIndex=c.zIndex,d},e=s(),ScratchController.prototype._singletonInstance?ScratchController.prototype._singletonInstance:(ScratchController.prototype._singletonInstance=this,document.addEventListener("touchstart",x,!1),document.addEventListener("touchmove",x,!1),document.addEventListener("touchend",x,!1),document.addEventListener("mousedown",x,!1),document.addEventListener("mousemove",x,!1),void document.addEventListener("mouseup",x,!1))};